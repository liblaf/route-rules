# This file is @generated by <https://github.com/liblaf/copier-release>.
# DO NOT EDIT!

name: Release Please

on:
  push:
    branches:
      - main

env:
  FORCE_COLOR: 1

concurrency:
  group: ${{ github.workflow }} @ ${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    name: Release Please
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    outputs:
      pr: ${{ steps.release-please.outputs.pr }}
      prs_created: ${{ steps.release-please.outputs.prs_created }}
      release_created: ${{ steps.release-please.outputs.release_created }}
      tag: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - id: auth
        name: Auth
        uses: liblaf/actions/auth@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ steps.auth.outputs.token }}
      - id: release-please
        name: Release Please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ steps.auth.outputs.token }}
          config-file: .config/release-please/config.json
          manifest-file: .config/release-please/.manifest.json

  post-pr:
    name: Post PR
    permissions:
      contents: write
      pull-requests: write
    needs:
      - release-please
    if: ${{ needs.release-please.outputs.pr }}
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    steps:
      - id: auth
        name: Auth
        uses: liblaf/actions/auth@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
      - id: tag
        name: Get Tag
        run: |-
          title='${{ fromJson(needs.release-please.outputs.pr).title }}'
          version="$(awk '{ print $NF }' <<< "$title")"
          printf 'tag=%s\n' "v$version" >> "$GITHUB_OUTPUT"
      - name: Changelog
        uses: liblaf/actions/changelog@v1
        with:
          output: CHANGELOG.md
          args: --tag '${{ steps.tag.outputs.tag }}'
      - id: message
        name: Get Commit Message
        run: |-
          delimiter="$(uuidgen)"
          message="$(git show --format='%B' --no-patch)"
          printf 'message<<%s\n%s\n%s\n' "$delimiter" "$message" "$delimiter" >> "$GITHUB_OUTPUT"
      - name: Undo Last Commit
        run: git reset --soft HEAD~1
      - name: Commit
        uses: liblaf/actions/commit@v1
        with:
          add-options: --verbose 'CHANGELOG.md'
          force: true
          message: ${{ steps.message.outputs.message }}
          ref: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}
          token: ${{ steps.auth.outputs.token }}
      - name: Add Label
        run: |-
          gh pr edit '${{ fromJson(needs.release-please.outputs.pr).number }}' --add-label 'automerge'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}

  post-release:
    name: Post Release
    permissions:
      contents: write
    needs:
      - release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    steps:
      - id: auth
        name: Auth
        uses: liblaf/actions/auth@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.release-please.outputs.tag }}
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
      - id: changelog
        name: Changelog
        uses: liblaf/actions/changelog@v1
        with:
          args: --current --strip all
      - name: Update Release Notes
        run: >-
          gh release edit '${{ needs.release-please.outputs.tag }}'
          --notes-file '${{ steps.changelog.outputs.changelog }}'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
